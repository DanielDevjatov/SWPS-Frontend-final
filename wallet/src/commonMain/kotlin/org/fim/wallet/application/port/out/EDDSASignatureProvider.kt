package org.fim.wallet.application.port.out

import com.ionspin.kotlin.bignum.integer.BigInteger
import org.fim.wallet.domain.eddsa.PrivateKey
import org.fim.wallet.domain.eddsa.PublicKey
import org.fim.wallet.domain.eddsa.Signature
import org.fim.wallet.domain.eddsa.toBigIntegerList
import org.fim.wallet.domain.zkp.CircomBigIntegerUtils.Companion.checkCircomValues
import kotlin.random.Random

/**
 * Port interface definition for EDDSA signature generation and verification.
 */
interface EDDSASignatureProvider {
  /**
   * Generates the [PublicKey] for a given [PrivateKey].
   *
   * @param privateKey   the [PrivateKey]
   *
   * @return the [PublicKey] for given [PrivateKey]
   */
  fun publicKey(privateKey: PrivateKey): PublicKey

  /**
   * Generates the [Signature] for a given message and [PrivateKey]
   *
   * @param message     the message (or object as [String]) to be signed
   * @param privateKey  the [PrivateKey] used to sign the [message]
   *
   * @return [Signature] for given message and key
   */
  fun sign(message: BigInteger, privateKey: PrivateKey): Signature

  /**
   * Verify a [Signature] for a given message and [PublicKey].
   *
   * @param message   the signed message (or object as [String])
   * @param signature the [Signature] of [message]
   * @param publicKey the [PublicKey] to verify the [signature] against
   *
   * @return true for a valid signature, false otherwise
   */
  fun verify(message: BigInteger, signature: Signature, publicKey: PublicKey): Boolean

  /**
   * Generate a new **unsafe** keypair.
   *
   * **NOTE**: This function is not safe for production use!
   * This is because the generated [PrivateKey] will be the next 32 random generated Bytes from [Random].
   *
   * @return [Pair] of [PrivateKey] and [PublicKey]
   */
  fun keyPair(): Pair<PrivateKey, PublicKey> {
    var privateKey: PrivateKey
    var publicKey: PublicKey
    do{
      privateKey = PrivateKey(ByteArray(1) + Random.nextBytes(31))
      publicKey  = publicKey(privateKey)
    }while(!((publicKey.toBigIntegerList().toTypedArray()).toList().checkCircomValues()))

    return Pair(privateKey,publicKey )
  }
}

